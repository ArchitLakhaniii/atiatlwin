<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketplace Parsing Playground</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0f172a;
        color: #f8fafc;
      }
      body {
        margin: 0;
        min-height: 100vh;
        padding: 2.5rem;
        box-sizing: border-box;
      }
      h1,
      h2,
      h3 {
        margin: 0;
      }
      h1 {
        font-size: 2rem;
        letter-spacing: -0.02em;
      }
      h2 {
        font-size: 1.25rem;
      }
      h3 {
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #cbd5f5;
      }
      p {
        margin: 0.5rem 0 0;
        color: #cbd5f5;
      }
      .layout {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: 1.75rem;
      }
      .panel {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 18px;
        padding: 1.75rem;
        box-shadow: 0 24px 55px rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(12px);
        display: grid;
        gap: 1.5rem;
      }
      .layout-columns {
        display: grid;
        gap: 1.75rem;
      }
      @media (min-width: 1024px) {
        .layout-columns {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      form,
      .stack {
        display: grid;
        gap: 1rem;
      }
      textarea {
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.6);
        color: inherit;
        min-height: 160px;
        resize: vertical;
        font-size: 1rem;
      }
      input[type="text"],
      select {
        padding: 0.85rem 1rem;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.6);
        color: inherit;
        font-size: 1rem;
      }
      button {
        justify-self: start;
        padding: 0.75rem 1.5rem;
        border-radius: 999px;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(135deg, #06b6d4, #2563eb);
        color: #f8fafc;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
      }
      button:disabled {
        cursor: wait;
        opacity: 0.7;
        transform: none;
        box-shadow: none;
      }
      pre {
        max-height: 320px;
        overflow: auto;
        background: rgba(15, 23, 42, 0.55);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
        margin: 0;
      }
      .status {
        min-height: 1.25rem;
        font-size: 0.95rem;
      }
      .status.error {
        color: #f87171;
      }
      .status.success {
        color: #34d399;
      }
      .history-grid {
        display: grid;
        gap: 1rem;
      }
      .result-card {
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 14px;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.6);
        display: grid;
        gap: 0.75rem;
      }
      .result-card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        background: rgba(37, 99, 235, 0.2);
        border: 1px solid rgba(37, 99, 235, 0.4);
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
      }
      .result-columns {
        display: grid;
        gap: 1.5rem;
      }
      @media (min-width: 900px) {
        .result-columns {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <section class="panel">
        <div>
          <h1>Marketplace Parsing Playground</h1>
          <p>
            Compare a buyer's Flash Request with the comprehensive SellerProfile dossier that powers the
            Smart-Ping system.
          </p>
        </div>
        <div class="layout-columns">
          <div class="stack">
            <div>
              <h2>Buyer Request Parser</h2>
              <p>Send a buyer request to <code>/api/parse-request</code>.</p>
            </div>
            <form id="buyer-form">
              <textarea id="buyer-text" placeholder="Looking to borrow a medium black hoodie for the weekend"></textarea>
              <button type="submit">Parse Buyer Request</button>
              <div id="buyer-status" class="status"></div>
            </form>
          </div>
          <div class="stack">
            <div>
              <h2>Seller Profile Parser</h2>
              <p>
                Paste a seller's bio and past sales summary. The parser will infer their major, inventory tendencies,
                and related categories.
              </p>
            </div>
            <div class="stack">
              <label for="profile-sample" style="font-weight: 600">Quick-load a sample seller</label>
              <select id="profile-sample">
                <option value="">-- Select sample profile --</option>
                <option value="techie">user_techie123 (Tech Enthusiast)</option>
                <option value="fashion">user_styleguru (Fashionista)</option>
                <option value="bookie">user_bookie (Budget Bookworm)</option>
              </select>
            </div>
            <form id="profile-form">
              <textarea
                id="profile-text"
                placeholder="Bio: ... Past Sales Summary (Last 12 months): ..."
              ></textarea>
              <input id="profile-user" type="text" placeholder="Seller user id (e.g. user_techie123)" />
              <button type="submit">Parse Seller Profile</button>
              <div id="profile-status" class="status"></div>
            </form>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Parsed Output</h2>
        <div class="result-columns">
          <div class="stack">
            <h3>Buyer FlashRequest</h3>
            <pre id="buyer-result">(waiting for input)</pre>
          </div>
          <div class="stack">
            <h3>Seller Profiles</h3>
            <div id="profile-history" class="history-grid">
              <div class="result-card">
                <header>
                  <span class="badge">Seller Profile</span>
                  <span>No profiles parsed yet.</span>
                </header>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <script>
      const buyerForm = document.getElementById('buyer-form');
      const buyerTextarea = document.getElementById('buyer-text');
      const buyerStatus = document.getElementById('buyer-status');
      const buyerResult = document.getElementById('buyer-result');

      const profileForm = document.getElementById('profile-form');
      const profileTextarea = document.getElementById('profile-text');
      const profileUserInput = document.getElementById('profile-user');
      const profileStatus = document.getElementById('profile-status');
      const profileHistory = document.getElementById('profile-history');
      const profileSampleSelect = document.getElementById('profile-sample');

      const profileResults = [];

      const sellerSamples = {
        techie: {
          userId: 'user_techie123',
          text: `Bio: Hey, I'm a 3rd-year Computer Science major living in Founders Hall. I'm a big gamer and often upgrade my setup, so I have a lot of old PC parts, gaming accessories, and electronics to sell. I've also tutored for intro CS classes, so I might have old textbooks.

Past Sales Summary (Last 12 months):
8 items in 'Electronics' (Avg Price: $120, mainly GPUs, monitors, cables; 100% Sell)
5 items in 'Gaming' (Avg Price: $40, mainly controllers, headsets; 80% Sell, 20% Lend)
3 items in 'Textbooks' (Avg Price: $30, CS-related; 100% Lend)
1 item in 'Apparel' (Old university hoodie; 100% Sell)
Overall Transaction Tendency: Mostly Sell (85%), some Lend (15%)`,
        },
        fashion: {
          userId: 'user_styleguru',
          text: `Bio: Hi! I'm a senior Fashion Design student in Unity Dorms. My closet is constantly changing for projects, so I frequently sell or lend out clothing, shoes, and accessories. I also sometimes have art supplies left over.

Past Sales Summary (Last 6 months):
15 items in 'Apparel' (Avg Price: $35, dresses, jackets, tops, bottoms; 60% Sell, 40% Lend)
7 items in 'Footwear' (Avg Price: $50, sneakers, heels; 70% Sell, 30% Lend)
4 items in 'Accessories' (Avg Price: $20, jewelry, bags; 50% Sell, 50% Lend)
2 items in 'Art Supplies' (Avg Price: $15, fabric, paints; 100% Sell)
Overall Transaction Tendency: Mixed (65% Sell, 35% Lend)`,
        },
        bookie: {
          userId: 'user_bookie',
          text: `Bio: Avid reader and English Literature major here! Living off-campus near the campus bookstore. I'm always looking for ways to save, so I frequently buy, sell, and lend literature, history, and philosophy textbooks. I also occasionally sell used study lamps or small furniture.

Past Sales Summary (Last 18 months):
20 items in 'Textbooks' (Avg Price: $25, Lit, History, Phil; 10% Sell, 90% Lend)
5 items in 'Office Supplies' (Avg Price: $10, lamps, desk organizers; 100% Sell)
2 items in 'Furniture' (Avg Price: $70, small shelves; 100% Sell)
Overall Transaction Tendency: Predominantly Lend (80%), some Sell (20%)`,
        },
      };

      profileSampleSelect.addEventListener('change', (event) => {
        const sample = sellerSamples[event.target.value];
        if (sample) {
          profileTextarea.value = sample.text;
          profileUserInput.value = sample.userId;
          profileStatus.textContent = '';
        }
      });

      function renderProfileHistory() {
        if (!profileResults.length) {
          profileHistory.innerHTML = `
            <div class="result-card">
              <header>
                <span class="badge">Seller Profile</span>
                <span>No profiles parsed yet.</span>
              </header>
            </div>
          `;
          return;
        }

        profileHistory.innerHTML = profileResults
          .map(
            (entry) => `
              <div class="result-card">
                <header>
                  <span class="badge">${entry.userId}</span>
                  <span>${entry.timestamp}</span>
                </header>
                <div>
                  <strong>Original Text</strong>
                  <p>${entry.text.replace(/\n/g, '<br />')}</p>
                </div>
                <div>
                  <strong>Parsed SellerProfile JSON</strong>
                  <pre>${entry.json}</pre>
                </div>
              </div>
            `,
          )
          .join('');
      }

      async function handleRequest({ url, body, statusNode, button }) {
        statusNode.textContent = 'Sending to Gemini...';
        statusNode.className = 'status';
        button.disabled = true;

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => null);
            throw new Error(errorPayload?.error || `Request failed with ${response.status}`);
          }

          statusNode.textContent = 'Success!';
          statusNode.className = 'status success';
          return await response.json();
        } catch (error) {
          console.error(error);
          statusNode.textContent = error.message || 'Unexpected error.';
          statusNode.className = 'status error';
          return null;
        } finally {
          button.disabled = false;
        }
      }

      buyerForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const text = buyerTextarea.value.trim();
        if (!text) {
          buyerStatus.textContent = 'Please enter a request.';
          buyerStatus.className = 'status error';
          return;
        }

        const data = await handleRequest({
          url: '/api/parse-request',
          body: { text },
          statusNode: buyerStatus,
          button: buyerForm.querySelector('button'),
        });

        if (data) {
          buyerResult.textContent = JSON.stringify(data, null, 2);
        }
      });

      profileForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const text = profileTextarea.value.trim();
        const userId = profileUserInput.value.trim();
        if (!text || !userId) {
          profileStatus.textContent = "Please provide both the seller's text blob and user id.";
          profileStatus.className = 'status error';
          return;
        }

        const data = await handleRequest({
          url: '/api/parse-profile',
          body: { text, userId },
          statusNode: profileStatus,
          button: profileForm.querySelector('button'),
        });

        if (data) {
          profileResults.unshift({
            text,
            userId,
            json: JSON.stringify(data, null, 2),
            timestamp: new Date().toLocaleString(),
          });
          renderProfileHistory();
        }
      });

      renderProfileHistory();
    </script>
  </body>
</html>
